<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body, #map {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Initialize map centered on Indonesia
    const map = L.map('map', {
      center: [-2.5, 118],
      zoom: 5,
      zoomControl: true
    });

    // Add CartoDB Voyager tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      maxZoom: 19
    }).addTo(map);

    // Listen for events from parent window
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'UPDATE_EVENTS') {
        const events = event.data.events;

        // Clear existing markers
        map.eachLayer(function(layer) {
          if (layer instanceof L.Marker) {
            map.removeLayer(layer);
          }
        });

        // Add markers for events
        const bounds = [];

        events.forEach(function(event) {
          if (event.latitude && event.longitude) {
            // Determine marker color
            const color = event.status === 'ongoing' ? '#22c55e' :
                         event.status === 'completed' ? '#6b7280' :
                         '#FF383C';

            // Create custom icon
            const customIcon = L.divIcon({
              className: 'custom-marker',
              html: '<div style="' +
                'background-color: ' + color + ';' +
                'width: 32px;' +
                'height: 32px;' +
                'border-radius: 50% 50% 50% 0;' +
                'transform: rotate(-45deg);' +
                'border: 3px solid white;' +
                'box-shadow: 0 2px 8px rgba(0,0,0,0.3);' +
                '"></div>',
              iconSize: [32, 32],
              iconAnchor: [16, 32],
              popupAnchor: [0, -32]
            });

            // Create marker
            const marker = L.marker([event.latitude, event.longitude], {
              icon: customIcon
            });

            // Create popup content
            const popupContent = '<div style="font-family: system-ui, -apple-system, sans-serif; padding: 8px; min-width: 200px;">' +
              '<h3 style="font-weight: bold; font-size: 16px; margin: 0 0 4px 0; color: #1f2937;">' + event.name + '</h3>' +
              (event.location ? '<p style="font-size: 13px; margin: 0 0 8px 0; color: #6b7280;">üìç ' + event.location + '</p>' : '') +
              (event.description ? '<p style="font-size: 13px; margin: 0 0 12px 0; color: #374151;">' + event.description + '</p>' : '') +
              '<div style="display: flex; gap: 8px;">' +
                '<a href="/event/' + event.slug + '" style="flex: 1; background-color: #FF383C; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; display: block;">View Details</a>' +
                '<a href="https://www.google.com/maps/dir/?api=1&destination=' + event.latitude + ',' + event.longitude + '" target="_blank" style="flex: 1; background-color: #f3f4f6; color: #374151; border: none; padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; text-decoration: none; text-align: center; display: block;">Directions</a>' +
              '</div>' +
            '</div>';

            marker.bindPopup(popupContent);
            marker.addTo(map);

            bounds.push([event.latitude, event.longitude]);
          }
        });

        // Fit map to show all markers
        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
        }
      }
    });

    // Tell parent window that map is ready
    window.parent.postMessage({ type: 'MAP_READY' }, '*');
  </script>
</body>
</html>
